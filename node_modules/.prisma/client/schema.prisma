generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String?
  createdAt DateTime @default(now())

  googleAccount     GoogleAccount?
  emailItems        EmailItem[]
  calendarEvents    CalendarEvent[]
  docItems          DocItem[]
  tasks             Task[]
  plans             Plan[]
  triageRuns        TriageRun[]
  learningMaterials LearningMaterial[]
}

model GoogleAccount {
  id              String   @id @default(uuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id])
  googleSub       String
  accessTokenEnc  String
  refreshTokenEnc String
  expiryDate      BigInt?
  scopes          String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model EmailItem {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  gmailId    String   @unique
  threadId   String?
  from       String
  subject    String
  snippet    String
  receivedAt DateTime
  isUnread   Boolean
  rawJson    String // Storing JSON as string for SQLite compatibility
}

model CalendarEvent {
  id       String   @id @default(uuid())
  userId   String
  user     User     @relation(fields: [userId], references: [id])
  gcalId   String   @unique
  title    String
  start    DateTime
  end      DateTime
  location String?
  rawJson  String
}

model DocItem {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  fileId        String   @unique
  title         String
  sourceType    String // 'doc' | 'folder'
  modifiedTime  DateTime
  extractedText String?
  textHash      String?
  rawJson       String
}

model Task {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  title       String
  description String?
  sourceType  String
  sourceId    String?
  dueAt       DateTime?
  estMins     Int?
  priority    String
  status      String
  createdAt   DateTime  @default(now())
}

model Plan {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  weekStartDate DateTime
  planJson      String
  createdAt     DateTime @default(now())
}

model TriageRun {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())
  resultJson String
}

model LearningMaterial {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  filename      String
  fileType      String
  extractedText String?
  createdAt     DateTime @default(now())

  artifacts LearningArtifact[]
}

model LearningArtifact {
  id                 String           @id @default(uuid())
  learningMaterialId String
  learningMaterial   LearningMaterial @relation(fields: [learningMaterialId], references: [id])
  type               String // 'summary' | 'graph' | 'mcq'
  artifactJson       String
  createdAt          DateTime         @default(now())
}
